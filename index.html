<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="/aframe.min.js"></script>
    <script src="/mindar-image-aframe.prod.js"></script>
  </head>
  <body>
    <a-scene
      id="escena"
      mindar-image="imageTargetSrc: /mejores.mind;"
      renderer="colorManagement: true, physicallyCorrectLights"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
    >
      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
      <a-entity mindar-image-target="targetIndex: 0">
        <a-plane
          id="e0"
          color="red"
          opaciy="0.5"
          position="0 0 0"
          height=".5"
          width=".5"
          rotation="0 0 0"
        ></a-plane>
        <a-text id="et0" value="Primera medida \n de este bloque"></a-text>
      </a-entity>
      <a-entity mindar-image-target="targetIndex: 1">
        <a-plane
          id="e1"
          color="red"
          opaciy="0.5"
          position="0 0 0"
          height=".5"
          width=".5"
          rotation="0 0 0"
        ></a-plane>
        <a-text id="et1" value="Primera medida \n de este bloque"></a-text>
      </a-entity>
      <a-entity mindar-image-target="targetIndex: 2">
        <a-plane
          id="e2"
          color="red"
          opaciy="0.5"
          position="0 0 0"
          height=".5"
          width=".5"
          rotation="0 0 0"
        ></a-plane>
        <a-text id="et2" value="Primera medida \n de este bloque"></a-text>
      </a-entity>
      <a-entity mindar-image-target="targetIndex: 3">
        <a-circle
          id="e3"
          radius=".25"
          color="red"
          opaciy="0.5"
          position="0 0 0"
          rotation="0 0 0"
        ></a-circle>
        <a-text id="et3" value="Primera medida \n de este bloque"></a-text>
      </a-entity>
      <a-entity mindar-image-target="targetIndex: 4">
        <a-circle
          id="e4"
          radius=".25"
          color="red"
          opaciy="0.5"
          position="0 0 0"
          rotation="0 0 0"
        ></a-circle>
        <a-text id="et4" value="Primera medida \n de este bloque"></a-text>
      </a-entity>
      <a-entity mindar-image-target="targetIndex: 5">
        <a-circle
          id="e5"
          radius=".25"
          color="red"
          opaciy="0.5"
          position="0 0 0"
          rotation="0 0 0"
        ></a-circle>
        <a-text id="et5" value="Primera medida \n de este bloque"></a-text>
      </a-entity>
    </a-scene>

    <script defer>
      var probabilidad_roja =
        parseInt(window.location.hash.slice(1) || "50") / 100;
      console.log(
        "El estado del sistema contiene una probabilidad de salir rojo en la primera medición de ",
        probabilidad_roja
      );
      var a_escena = document.getElementById("escena");
      var estado = [false, false, false, false, false, false]; //estado inicial, ninguna cara medida.

      // Revisión de medición y cambio de estado.
      a_escena.addEventListener("targetFound", (event) => {
        let cara_presente =
          event.target.components["mindar-image-target"].attrValue.targetIndex;
        let cara_opuesta_presente = (parseInt(cara_presente) + 3) % 6;
        let elemento = document.getElementById(`e${cara_presente}`);
        let texto_elemento = document.getElementById(`et${cara_presente}`);

        console.log(
          "Se muestra la imagen ",
          cara_presente,
          " y la cara opesta es ",
          cara_opuesta_presente
        );
        if (
          estado[cara_presente] === false &&
          estado[cara_opuesta_presente] === true
        ) {
          let color_elegido = Math.random() <= 0.5 ? "red" : "blue";
          console.log(
            "cambio de color por ",
            color_elegido,
            ". mediciones ",
            estado
          );
          elemento.setAttribute("color", color_elegido);
          texto_elemento.setAttribute("value", " ");
          estado[cara_presente] = true;
          estado[cara_opuesta_presente] = false;
          console.log("cambio de color, mediciones ", estado);
        } else if (
          estado[cara_presente] === false &&
          estado[cara_opuesta_presente] === false
        ) {
          // esta caso corresponde con la primera medición y se prepara el estado para eso.
          console.log("primera medición de la cara", cara_presente);
          color_elegido = Math.random() <= probabilidad_roja ? "red" : "blue";
          elemento.setAttribute("color", color_elegido);
          estado[cara_presente] = true;
          estado[cara_opuesta_presente] = false;
          console.log("cambio de color, mediciones ", estado);
        }
      });
    </script>
  </body>
</html>
