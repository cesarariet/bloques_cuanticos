<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="/aframe.min.js"></script>
    <script src="/mindar-image-aframe.prod.js"></script>
  </head>
  <body>
    <a-scene
      id="escena"
      mindar-image="imageTargetSrc: /mejores.mind; ui-scanning: no"
      renderer="colorManagement: true, physicallyCorrectLights"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
    >
      <a-camera position="0 0 0" look-controls="enabled: false"> </a-camera>
      <div
        id="divParaPrepararEstado"
        style="
          display: none;
          position: absolute;
          left: 0;
          right: 0;
          bottom: 0;
          z-index: 1000;
          background: black;
          opacity: 0.7;
          color: white;
          padding: 10px;
          margin: 10px;
          border-radius: 10px;
        "
      >
        Para preparar el bloque cuántico, seleccione el estado deseado y
        presione PREPARAR.
        <br />
        <div style="text-align: center">
          <form>
            <label for="experimento">Experimento:</label>
            <select id="experimento">
              <option value="0">Estado A</option>
              <option value="33">Estado B</option>
              <option value="66">Estano C</option>
              <option value="100">Estado D</option></select
            ><br />
            <button type="button" onclick="prepararEstado()">PREPARAR</button>
          </form>
        </div>
      </div>
      <a-entity mindar-image-target="targetIndex: 0">
        <a-plane
          id="e0"
          color="red"
          opaciy="0.5"
          position="0 0 0"
          height=".5"
          width=".5"
          rotation="0 0 0"
        ></a-plane>
        <a-text id="et0" value=" "></a-text>
      </a-entity>
      <a-entity mindar-image-target="targetIndex: 1">
        <a-plane
          id="e1"
          color="red"
          opaciy="0.5"
          position="0 0 0"
          height=".5"
          width=".5"
          rotation="0 0 0"
        ></a-plane>
        <a-text id="et1" value=" "></a-text>
      </a-entity>
      <a-entity mindar-image-target="targetIndex: 2">
        <a-plane
          id="e2"
          color="red"
          opaciy="0.5"
          position="0 0 0"
          height=".5"
          width=".5"
          rotation="0 0 0"
        ></a-plane>
        <a-text id="et2" value=" "></a-text>
      </a-entity>
      <a-entity mindar-image-target="targetIndex: 3">
        <a-circle
          id="e3"
          radius=".25"
          color="red"
          opaciy="0.5"
          position="0 0 0"
          rotation="0 0 0"
        ></a-circle>
        <a-text id="et3" value=" "></a-text>
      </a-entity>
      <a-entity mindar-image-target="targetIndex: 4">
        <a-circle
          id="e4"
          radius=".25"
          color="red"
          opaciy="0.5"
          position="0 0 0"
          rotation="0 0 0"
        ></a-circle>
        <a-text id="et4" value=" "></a-text>
      </a-entity>
      <a-entity mindar-image-target="targetIndex: 5">
        <a-circle
          id="e5"
          radius=".25"
          color="red"
          opaciy="0.5"
          position="0 0 0"
          rotation="0 0 0"
        ></a-circle>
        <a-text id="et5" value=" "></a-text>
      </a-entity>
    </a-scene>

    <script defer>
      // probabilidad por defecto, que viene del hash de dirección url
      var probabilidad_roja =
        parseInt(window.location.hash.slice(1) || "50") / 100;
      console.log(
        "El estado del sistema contiene una probabilidad de salir rojo en la primera medición de ",
        probabilidad_roja
      );
      var a_escena = document.getElementById("escena");
      var estado = [false, false, false, false, false, false]; //estado inicial, ninguna cara medida.
      var cara_presente = null;
      var cara_opuesta_presente = null;
      var elemento = null;
      var texto_elemento = null;

      function prepararEstado() {
        // solo funciona si hay un target en pantalla!
        if (cara_presente === null)
          return console.log("no se encontró ningún target");
        // obteniendo la elección de experimento
        let estado_elegido =
          parseInt(document.getElementById("experimento").value) / 100;
        probabilidad_roja = estado_elegido;
        estado[cara_presente] = false;
        estado[cara_opuesta_presente] = false;
        elemento.setAttribute("color", "gray");
        texto_elemento.setAttribute(
          "value",
          "Estado preparado, \n retirar el bloque y \n volver para medir."
        );
      }
      // Revisión de medición y cambio de estado.
      a_escena.addEventListener("targetFound", (event) => {
        // mostrar el divParaPrepararEstado
        document.getElementById("divParaPrepararEstado").style.display =
          "block";
        cara_presente =
          event.target.components["mindar-image-target"].attrValue.targetIndex;
        cara_opuesta_presente = (parseInt(cara_presente) + 3) % 6;
        elemento = document.getElementById(`e${cara_presente}`);
        texto_elemento = document.getElementById(`et${cara_presente}`);
        console.log(
          "Se muestra la imagen ",
          cara_presente,
          " y la cara opesta es ",
          cara_opuesta_presente
        );
        if (
          estado[cara_presente] === false &&
          estado[cara_opuesta_presente] === true
        ) {
          let color_elegido = Math.random() <= 0.5 ? "red" : "blue";
          console.log(
            "cambio de color por ",
            color_elegido,
            ". mediciones ",
            estado
          );
          elemento.setAttribute("color", color_elegido);
          texto_elemento.setAttribute("value", " ");
          estado[cara_presente] = true;
          estado[cara_opuesta_presente] = false;
          console.log("cambio de color, mediciones ", estado);
        } else if (
          estado[cara_presente] === false &&
          estado[cara_opuesta_presente] === false
        ) {
          // esta caso corresponde con la primera medición y se prepara el estado para eso.
          console.log("primera medición de la cara", cara_presente);
          color_elegido = Math.random() <= probabilidad_roja ? "red" : "blue";
          elemento.setAttribute("color", color_elegido);
          texto_elemento.setAttribute(
            "value",
            "Primera medida \nde este bloque"
          );
          estado[cara_presente] = true;
          estado[cara_opuesta_presente] = false;
          console.log("cambio de color, mediciones ", estado);
        } else if (
          estado[cara_presente] === true &&
          estado[cara_opuesta_presente] == false
        ) {
          texto_elemento.setAttribute("value", " ");
        }
      });
      a_escena.addEventListener("targetLost", (event) => {
        document.getElementById("divParaPrepararEstado").style.display = "none";
        cara_presente = null;
        cara_opuesta_presente = null;
        elemento = null;
        texto_elemento = null;
      });
    </script>
  </body>
</html>
